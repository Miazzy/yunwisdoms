"use strict";var classCallCheck=function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")},createClass=function(){function r(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(e,n,t){return n&&r(e.prototype,n),t&&r(e,t),e}}(),Dep=function(){function e(){classCallCheck(this,e),this.deps=[]}return createClass(e,[{key:"add",value:function(e){this.deps.push(e)}},{key:"notify",value:function(){for(var e=0;e<this.deps.length;e++)this.deps[e]();this.deps.length=0}}]),e}(),NAME="idb-js";function log_error(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"";throw new Error(NAME+"："+e)}function log(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"";console.log(NAME+"："+e)}var indexedDB=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB,IDBTransaction=window.IDBTransaction||window.webkitIDBTransaction||window.msIDBTransaction,IDBKeyRange=window.IDBKeyRange||window.webkitIDBKeyRange||window.msIDBKeyRange,isObject=function(e){return"[object Object]"===Object.prototype.toString.call(e)},isArray=function(e){return"[object Array]"===Object.prototype.toString.call(e)},DB=function(){function r(e){var n=e.dbName,t=e.version;classCallCheck(this,r),this.dbName=n,this.version=t,this.db=null,this.idb=null,this.table=[],this._status=!1,this._dep_=new Dep}return createClass(r,[{key:"open",value:function(e){var t=this,n=function(){},r=function(){};if(e&&(n=e.success?e.success:n,r=e.error?e.error:r),0!=this.table.length||this._status)if("function"==typeof n){var o=indexedDB.open(this.dbName,this.version);o.onerror=function(e){r(e.currentTarget.error.message)},o.onsuccess=function(e){t.db=e.target.result,n(t.db),t._dep_.notify()},o.onupgradeneeded=function(e){t.idb=e.target.result;for(var n=0;n<t.table.length;n++)t.__create_table(t.idb,t.table[n])}}else log_error("open中success必须是一个function类型");else log_error("打开前要先用add_table添加表")}},{key:"close_db",value:function(){var e=this;this.__action(function(){e.db.close()})}},{key:"delete_db",value:function(){indexedDB.deleteDatabase(name)}},{key:"clear_table",value:function(e){var n=this,t=e.tableName;this.__action(function(){return n.__create_transaction(t,"readwrite").clear()})}},{key:"add_table",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};this._status=!1,this.table.push(e)}},{key:"queryAll",value:function(e){var n=this,r=e.tableName,t=e.success,o=void 0===t?function(){}:t;if("function"==typeof o){this.__action(function(){var t=[];n.__create_transaction(r,"readonly").openCursor().onsuccess=function(e){return n.__cursor_success(e,{condition:function(){return!0},handler:function(e){var n=e.currentValue;return t.push(n)},over:function(){return o(t)}})}})}else log_error("queryAll方法中success必须是一个Function类型")}},{key:"query",value:function(e){var n=this,r=e.tableName,o=e.condition,t=e.success,i=void 0===t?function(){}:t;if("function"==typeof i)if("function"==typeof o){this.__action(function(){var t=[];n.__create_transaction(r,"readonly").openCursor().onsuccess=function(e){return n.__cursor_success(e,{condition:o,handler:function(e){var n=e.currentValue;return t.push(n)},over:function(){return i(t)}})}})}else log_error("in query,condition is required,and type is function");else log_error("query方法中success必须是一个Function类型")}},{key:"insert",value:function(e){var t=this,r=e.tableName,o=e.data,n=e.success,i=void 0===n?function(){}:n;isArray(o)||isObject(o)?"function"==typeof i?this.__action(function(){var n=t.__create_transaction(r,"readwrite");isArray(o)?o.forEach(function(e){return n.put(e)}):n.put(o),i()}):log_error("insert方法中success必须是一个Function类型"):log_error("in insert，data type is Object or Array")}},{key:"delete",value:function(e){var n=this,t=e.tableName,o=e.condition,r=e.success,i=void 0===r?function(){}:r;if("function"==typeof i)if("function"==typeof o){this.__action(function(){var r=[];n.__create_transaction(t,"readwrite").openCursor().onsuccess=function(e){return n.__cursor_success(e,{condition:o,handler:function(e){var n=e.currentValue,t=e.cursor;r.push(n),t.delete()},over:function(){0!=r.length?i(r):log_error("in delete ,数据库中没有任何符合condition的元素")}})}})}else log_error("in delete,condition is required,and type is function");else log_error("delete方法中success必须是一个Function类型")}},{key:"delete_by_primaryKey",value:function(e){var n=this,t=e.tableName,r=e.target,o=e.success,i=void 0===o?function(){}:o,a=e.error,c=void 0===a?function(){}:a;"function"==typeof i?this.__action(function(){var e=n.__create_transaction(t,"readwrite").delete(r);e.onsuccess=function(){return i()},e.onerror=function(){return c()}}):log_error("in delete_by_primaryKey，success必须是一个Function类型")}},{key:"update_by_primaryKey",value:function(e){var n=this,r=e.tableName,o=e.target,t=e.success,i=void 0===t?function(){}:t,a=e.handle;"function"==typeof i?"function"==typeof a?this.__action(function(){var t=n.__create_transaction(r,"readwrite");t.get(o).onsuccess=function(e){var n=e.target.result;a(n),t.put(n),i(n)}}):log_error("in update_by_primaryKey，handle必须是一个Function类型"):log_error("in update_by_primaryKey，success必须是一个Function类型")}},{key:"update",value:function(e){var n=this,t=e.tableName,o=e.condition,i=e.handle,r=e.success,a=void 0===r?function(){}:r;if("function"==typeof i)if("function"==typeof a)if("function"==typeof o){this.__action(function(){var r=[];n.__create_transaction(t,"readwrite").openCursor().onsuccess=function(e){return n.__cursor_success(e,{condition:o,handler:function(e){var n=e.currentValue,t=e.cursor;i(n),r.push(n),t.update(n)},over:function(){0!=r.length?a(r):log_error("in update ,数据库中没有任何符合condition的元素")}})}})}else log_error("in update,condition is required,and type is function");else log_error("in update,success必须是一个function类型");else log_error("in update,handle必须是一个function类型")}},{key:"query_by_primaryKey",value:function(e){var n=this,t=e.tableName,r=e.target,o=e.success,i=void 0===o?function(){}:o;if("function"==typeof i){this.__action(function(){n.__create_transaction(t,"readonly").get(r).onsuccess=function(e){var n=e.target.result;i(n||null)}})}else log_error("in query_by_primaryKey,success必须是一个Function类型")}},{key:"query_by_index",value:function(e){var n=this,t=e.tableName,r=e.indexName,o=e.target,i=e.success,a=void 0===i?function(){}:i;if("function"==typeof a){this.__action(function(){n.__create_transaction(t,"readonly").index(r).get(o).onsuccess=function(e){var n=e.target.result;a(n||null)}})}else log_error("in query_by_index,success必须是一个Function类型")}},{key:"__cursor_success",value:function(e,n){var t=n.condition,r=n.handler,o=n.over,i=e.target.result;if(i){var a=i.value;t(a)&&r({cursor:i,currentValue:a}),i.continue()}else o()}},{key:"__create_transaction",value:function(e){var n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"readwrite";if(!e||!n)throw new Error("in __create_transaction,tableName and mode is required");return this.db.transaction(e,n).objectStore(e)}},{key:"__action",value:function(e){var n=function(){e()};this.db?n():this._dep_.add(n)}},{key:"__create_table",value:function(e,n){var t=n.tableName,r=n.option,o=n.indexs,i=void 0===o?[]:o;if(!e.objectStoreNames.contains(t)){var a=e.createObjectStore(t,r),c=!0,s=!1,u=void 0;try{for(var l,d=i[Symbol.iterator]();!(c=(l=d.next()).done);c=!0){var f=l.value;this.__create_index(a,f)}}catch(e){s=!0,u=e}finally{try{!c&&d.return&&d.return()}finally{if(s)throw u}}}}},{key:"__create_index",value:function(e,n){var t=n.key,r=n.option;e.createIndex(t,t,r)}}]),r}();function Idb(e){var t=e.dbName,n=e.version,r=void 0===n?(new Date).getTime():n,o=e.tables,i=void 0===o?[]:o,a=new DB({dbName:t,version:r}),c=!0,s=!1,u=void 0;try{for(var l,d=i[Symbol.iterator]();!(c=(l=d.next()).done);c=!0){var f=l.value;a.add_table(f)}}catch(e){s=!0,u=e}finally{try{!c&&d.return&&d.return()}finally{if(s)throw u}}return new Promise(function(e,n){a.open({success:function(){log("数据库 "+t+" 已经打开"),e(a)},error:function(e){n(e)}})})}module.exports=Idb;
